---
import { getCollection, type CollectionEntry } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";

const photos = (await getCollection("photography"))
  .sort((a: CollectionEntry<"photography">, b: CollectionEntry<"photography">) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<BaseLayout title="Photography">
  <h1>Photography</h1>

  {photos.length === 0 ? (
    <p>No photos yet. Add them in /admin.</p>
  ) : (
    <div class="gallery" id="photo-gallery">
      {photos.map((photo: CollectionEntry<"photography">) => (
        <figure class="photo">
          <button
            class="photo-button"
            type="button"
            data-full={photo.data.image}
            data-caption={photo.data.caption ?? photo.data.title ?? ""}
          >
            <img src={photo.data.image} alt={photo.data.alt ?? photo.data.title} loading="lazy" />
          </button>
          {(photo.data.caption || photo.data.title) && (
            <figcaption>{photo.data.caption ?? photo.data.title}</figcaption>
          )}
        </figure>
      ))}
    </div>
  )}

  <div class="lightbox" id="photo-lightbox" aria-hidden="true">
    <div class="lightbox-frame" role="dialog" aria-modal="true" aria-label="Photo viewer">
      <button class="lightbox-close" type="button" aria-label="Close">✕</button>
      <button class="lightbox-prev" type="button" aria-label="Previous">‹</button>
      <button class="lightbox-next" type="button" aria-label="Next">›</button>
      <img class="lightbox-image" src="" alt="" />
      <div class="lightbox-caption"></div>
    </div>
  </div>

  <style>
    .gallery {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 16px;
    }

    @media (max-width: 1100px) {
      .gallery {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 800px) {
      .gallery {
        grid-template-columns: 1fr;
      }
    }

    .photo {
      margin: 0;
    }

    .photo-button {
      display: block;
      width: 100%;
      padding: 0;
      border: 0;
      background: transparent;
      cursor: pointer;
    }

    .photo img {
      width: 100%;
      height: auto;
      display: block;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .photo figcaption {
      margin-top: 8px;
      text-align: center;
      font-size: 0.95em;
      opacity: 0.85;
    }

    .lightbox {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 999;
      overscroll-behavior: contain;
      touch-action: none;
    }

    .lightbox.is-open {
      display: flex;
    }

    .lightbox-frame {
      position: relative;
      max-width: min(1200px, 95vw);
      max-height: 90vh;
      width: 100%;
      background: #000;
      border-top: 3px solid rgba(255, 255, 255, 0.35);
      border-left: 3px solid rgba(255, 255, 255, 0.35);
      border-right: 3px solid rgba(255, 255, 255, 0.12);
      border-bottom: 3px solid rgba(255, 255, 255, 0.12);
      box-shadow:
        inset 2px 2px 0 rgba(255, 255, 255, 0.08),
        inset -2px -2px 0 rgba(0, 0, 0, 0.6),
        0 0 0 2px rgba(255, 255, 255, 0.08);
      padding: 23px 59px 19px;
    }

    .lightbox-image {
      display: block;
      max-width: 100%;
      max-height: 70vh;
      margin: 0 auto;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .lightbox-caption {
      margin-top: 10px;
      text-align: center;
      font-size: 0.95em;
      opacity: 0.85;
    }

    .lightbox-close {
      position: absolute;
      top: 10px;
      right: 10px;
      border: 0;
      background: transparent url("/x-button.png") no-repeat center / contain;
      width: 32px;
      height: 32px;
      padding: 0;
      color: transparent;
      font-size: 0;
      cursor: pointer;
    }

    .lightbox-prev,
    .lightbox-next {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      border: 0;
      background: transparent url("/arrow.png") no-repeat center / contain;
      width: 36px;
      height: 36px;
      padding: 0;
      color: transparent;
      font-size: 0;
      cursor: pointer;
    }

    .lightbox-prev { left: 6px; top: 50%; }
    .lightbox-next { right: 6px; top: calc(50% - 15px); transform: translateY(-50%) scaleX(-1); }

    :global(html.lightbox-open),
    :global(body.lightbox-open) {
      overflow: hidden;
      height: 100%;
      touch-action: none;
    }
  </style>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const gallery = document.getElementById("photo-gallery");
      const lightbox = document.getElementById("photo-lightbox");
      const lightboxImage = lightbox?.querySelector(".lightbox-image");
      const lightboxCaption = lightbox?.querySelector(".lightbox-caption");
      const closeButton = lightbox?.querySelector(".lightbox-close");
      const prevButton = lightbox?.querySelector(".lightbox-prev");
      const nextButton = lightbox?.querySelector(".lightbox-next");
      const buttons = Array.from(
        gallery?.querySelectorAll(".photo-button") ?? []
      );
      let currentIndex = -1;

      const closeLightbox = () => {
        lightbox?.classList.remove("is-open");
        lightbox?.setAttribute("aria-hidden", "true");
        document.documentElement.classList.remove("lightbox-open");
        document.body.classList.remove("lightbox-open");
        if (lightboxImage) {
          lightboxImage.src = "";
          lightboxImage.alt = "";
        }
        if (lightboxCaption) {
          lightboxCaption.textContent = "";
        }
        currentIndex = -1;
      };

      const openAtIndex = (index) => {
        if (index < 0 || index >= buttons.length) return;
        const button = buttons[index];
        const full = button.getAttribute("data-full");
        if (!full) return;
        const caption = button.getAttribute("data-caption") ?? "";
        if (lightboxImage) {
          lightboxImage.src = full;
          lightboxImage.alt = caption;
        }
        if (lightboxCaption) {
          lightboxCaption.textContent = caption;
        }
        currentIndex = index;
        lightbox?.classList.add("is-open");
        lightbox?.setAttribute("aria-hidden", "false");
        document.documentElement.classList.add("lightbox-open");
        document.body.classList.add("lightbox-open");
      };

      const step = (delta) => {
        if (!buttons.length) return;
        const nextIndex = currentIndex === -1
          ? 0
          : (currentIndex + delta + buttons.length) % buttons.length;
        openAtIndex(nextIndex);
      };

      gallery?.addEventListener("click", (event) => {
        const target = event.target;
        const button = target instanceof HTMLElement ? target.closest(".photo-button") : null;
        if (!button || !(button instanceof HTMLElement)) return;
        const index = buttons.indexOf(button);
        if (index === -1) return;
        openAtIndex(index);
      });

      closeButton?.addEventListener("click", closeLightbox);
      prevButton?.addEventListener("click", () => step(-1));
      nextButton?.addEventListener("click", () => step(1));

      lightbox?.addEventListener("click", (event) => {
        if (event.target === lightbox) {
          closeLightbox();
        }
      });

      let touchStartX = 0;
      let touchEndX = 0;

      lightbox?.addEventListener("touchstart", (event) => {
        touchStartX = event.changedTouches[0]?.clientX ?? 0;
      }, { passive: true });

      lightbox?.addEventListener("touchend", (event) => {
        touchEndX = event.changedTouches[0]?.clientX ?? 0;
        const delta = touchEndX - touchStartX;
        if (Math.abs(delta) < 40) return;
        if (delta > 0) {
          step(-1);
        } else {
          step(1);
        }
      }, { passive: true });

      window.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeLightbox();
        } else if (event.key === "ArrowLeft") {
          step(-1);
        } else if (event.key === "ArrowRight") {
          step(1);
        }
      });
    });
  </script>
</BaseLayout>
